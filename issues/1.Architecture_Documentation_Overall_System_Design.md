## Overview
This document outlines the architecture for goon.ai, a Rust-based background process that spawns GUI elements controlled by an LLM through TypeScript execution.
## System Architecture
```mermaid
graph TB
    subgraph "Core Application"
        Main[Main Loop]
        Config[Configuration System]
        Pack[Pack Loader]
    end

    subgraph "LLM Layer"
        Ollama[Ollama Client]
        Prompt[Prompt Builder]
        Conv[Conversation Manager]
    end

    subgraph "Compilation & Execution"
        SWC[SWC Compiler]
        Deno[deno_core Runtime]
        SDK[SDK Generator]
    end

    subgraph "Permissions"
        PermResolver[Permission Resolver]
        PermChecker[Permission Checker]
    end

    subgraph "Asset Management"
        AssetRegistry[Asset Registry]
        MoodFilter[Mood-Based Filter]
        AssetSelector[Asset Selector]
    end

    subgraph "GUI & Rendering"
        WinMgr[Window Manager<br/>winit + wgpu]
        ImgRender[Image Renderer]
        VidRender[Video Renderer<br/>libmpv2]
        AudioPlayer[Audio Player]
        TextRender[Text Renderer]
    end

    subgraph "System Integration"
        Wallpaper[Wallpaper Setter]
        Browser[Browser Opener]
    end

    Main --> Ollama
    Main --> SWC
    Main --> Deno

    Ollama --> Prompt
    Ollama --> Conv

    Config --> Pack
    Config --> PermResolver
    Pack --> AssetRegistry

    PermResolver --> PermChecker
    PermResolver --> SDK

    SDK --> Prompt
    SWC --> Deno

    Deno --> WinMgr
    Deno --> AudioPlayer
    Deno --> Wallpaper
    Deno --> Browser
    Deno --> AssetSelector

    AssetSelector --> MoodFilter
    MoodFilter --> AssetRegistry

    WinMgr --> ImgRender
    WinMgr --> VidRender
    WinMgr --> TextRender

    PermChecker -.validates.-> Deno
```
## Application Flow
```mermaid
sequenceDiagram
    participant App as Application
    participant LLM as LLM (Ollama)
    participant SWC as SWC Compiler
    participant Deno as deno_core
    participant Ops as Rust Ops
    participant Assets as Asset Manager
    participant GUI as GUI Layer

    App->>App: 1. Initialize
    App->>App: 2. Load Pack & Assets

    loop Main Loop
        App->>LLM: 4. Call with context + SDK
        Note over LLM: LLM knows image.show()<br/>exists, but NOT asset list
        LLM->>App: 5. Return TypeScript: image.show()

        App->>SWC: 6. Compile TypeScript
        alt Compilation Error
            SWC->>App: Error details
            App->>LLM: Retry with error
        else Success
            SWC->>App: JavaScript code

            App->>Deno: 7. Execute JavaScript
            alt Runtime Error
                Deno->>App: Error details
                App->>LLM: Retry with error
            else Success
                Deno->>Ops: 8. Call op_show_image()
                Ops->>Assets: Get image for current mood
                Assets->>Assets: Filter by mood tags
                Assets->>Assets: Select random asset
                Assets->>Ops: Return asset path
                Ops->>GUI: Render image
                GUI->>Ops: WindowHandle
                Ops->>Deno: Return values
                Deno->>App: Execution results
                App->>LLM: 9. Continue with results
            end
        end
    end
```
## Asset Selection Flow (Key Architecture Change)
```mermaid
flowchart LR
    LLM[LLM] -->|"image.show()"| Binding[Rust Op]
    Binding -->|"Request asset"| AssetMgr[Asset Manager]
    AssetMgr -->|"Get current mood"| Settings[Settings]
    Settings -->|"Nature mood"| AssetMgr
    AssetMgr -->|"Filter by mood tags"| Registry[Asset Registry]
    Registry -->|"Assets with nature tags"| AssetMgr
    AssetMgr -->|"Random select"| AssetMgr
    AssetMgr -->|"beach.jpg path"| Binding
    Binding -->|"Render"| GUI[GUI]

    Note1[LLM never sees<br/>asset list]
    Note2[Reduces context<br/>size significantly]
```
## Component Interaction
```mermaid
graph LR
    subgraph "Configuration Files"
        Settings[settings.yaml]
        PackConfig[pack/config.yaml]
    end

    subgraph "Permission Flow"
        Settings -->|user perms| Union[Permission Union]
        PackConfig -->|pack perms| Union
        Union --> Filter[SDK Filter]
        Filter --> TSGen[TypeScript Definitions]
    end

    subgraph "Asset Flow - NO LLM EXPOSURE"
        PackConfig --> AssetMeta[Asset Metadata]
        AssetFiles[Asset Files] --> AssetReg[Asset Registry]
        AssetMeta --> AssetReg
        Settings --> CurrentMood[Current Mood]
        CurrentMood -.filters.-> AssetReg
        AssetReg -->|runtime selection| OpsLayer[Rust Ops]
    end

    TSGen --> LLMPrompt[LLM Prompt]
    Note[Assets NOT in prompt]
```
## Module Structure
```mermaid
graph TB
    subgraph "src/"
        Main[main.rs]

        subgraph "config/"
            Settings[settings.rs]
            Pack[pack.rs]
        end

        subgraph "core/"
            App[app.rs]
        end

        subgraph "llm/"
            Client[client.rs]
            Prompt[prompt.rs]
            Conv[conversation.rs]
        end

        subgraph "typescript/"
            Compiler[compiler.rs]
            SDKGen[sdk_generator.rs]
        end

        subgraph "runtime/"
            Runtime[runtime.rs]
            Ops[ops.rs]
        end

        subgraph "permissions/"
            PermTypes[types.rs]
            Resolver[resolver.rs]
        end

        subgraph "gui/"
            WinMgr[window_manager.rs]
            Window[window.rs]
            Renderer[renderer.rs]
        end

        subgraph "media/"
            Image[image/]
            Video[video/]
            Audio[audio/]
            Text[prompt/]
            Wall[wallpaper/]
            Web[website/]
        end

        subgraph "assets/"
            Loader[loader.rs]
            Registry[registry.rs]
            Selector[selector.rs]
        end
    end

    Main --> App
    App --> Settings
    App --> Pack
    App --> Client
    App --> Compiler
    App --> Runtime
```
## Data Flow: Asset Selection at Runtime
```mermaid
flowchart TD
    Start([Op Called: image.show]) --> GetMood[Get Current Mood from Settings]
    GetMood --> CheckMood{Mood Active?}

    CheckMood -->|Yes| FilterByMood[Filter Assets by Mood Tags]
    CheckMood -->|No| AllAssets[Get All Image Assets]

    FilterByMood --> CheckFiltered{Assets Found?}
    AllAssets --> CheckAll{Assets Found?}

    CheckFiltered -->|No| Error[Error: No matching assets]
    CheckFiltered -->|Yes| SelectRandom1[Select Random Asset]

    CheckAll -->|No| Error
    CheckAll -->|Yes| SelectRandom2[Select Random Asset]

    SelectRandom1 --> LoadAsset[Load Asset Data]
    SelectRandom2 --> LoadAsset

    LoadAsset --> ReturnPath[Return Asset Path/Data]
    ReturnPath --> End([Continue Rendering])
```
## LLM Context Building (Simplified - No Assets)
```mermaid
flowchart LR
    subgraph "Build Context"
        SystemPrompt[System Prompt<br/>from Pack]
        MoodPrompt[Mood Prompt<br/>describes current mood]
        SDK[SDK Definitions<br/>image.show, video.play, etc]
        History[Recent History]
        Errors[Previous Errors]
        UserProfile[User Profile]
    end

    SystemPrompt --> Combine[Combine into<br/>Full Prompt]
    MoodPrompt --> Combine
    SDK --> Combine
    History --> Combine
    Errors --> Combine
    UserProfile --> Combine

    Combine --> LLM[Send to LLM]

    Note[Asset list NOT included<br/>Reduces context significantly]
```
## Dependencies
```mermaid
graph LR
    subgraph "Core"
        Tokio[tokio]
        Serde[serde]
        Anyhow[anyhow]
        Tracing[tracing]
    end

    subgraph "LLM"
        OllamaRS[ollama-rs]
    end

    subgraph "TypeScript/JS"
        SWC[swc]
        DenoCore[deno_core]
    end

    subgraph "GUI/Graphics"
        Winit[winit]
        Wgpu[wgpu]
        Libmpv[libmpv2]
        Image[image]
        Text[cosmic-text]
    end

    subgraph "Audio"
        Rodio[rodio]
    end

    subgraph "System"
        Open[open]
        URL[url
