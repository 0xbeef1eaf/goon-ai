## Objective
Implement video playback using libmpv2 with automatic library download, integrated with winit/wgpu windows.
## Tasks
### 1. Video Module Structure
- [ ] Create video rendering module:
  ```
  src/
  └── media/
      └── video/
          ├── mod.rs
          ├── player.rs         // mpv player wrapper
          ├── downloader.rs     // libmpv auto-download
          └── renderer.rs       // Integration with wgpu
  ```
### 2. libmpv2 Integration
- [ ] Add dependencies:
  ```toml
  [dependencies]
  libmpv2 = "4.0"
  libmpv2-sys = "4.0"
  ```
- [ ] Set up libmpv initialization:
  ```rust
  let mpv = Mpv::new()?;
  mpv.set_property("vo", "libmpv")?;
  mpv.set_property("hwdec", "auto")?;
  ```
### 3. Auto-Download System
- [ ] Detect if libmpv is installed:
  - Check system paths
  - Check common install locations
  - Verify version compatibility
- [ ] Download libmpv if missing:
  - Determine platform (Windows/Linux/macOS)
  - Download appropriate binary
  - Extract to app directory
  - Set library path
- [ ] Download sources:
  - **Windows**: https://sourceforge.net/projects/mpv-player-windows/
  - **Linux**: System package manager (instructions)
  - **macOS**: Homebrew or prebuilt binary
- [ ] Cache downloaded library for future use
### 4. Video Player Wrapper
- [ ] Implement `VideoPlayer`:
  ```rust
  pub struct VideoPlayer {
      mpv: Mpv,
      render_context: MpvRenderContext,
      playing: Arc<AtomicBool>,
  }
  ```
- [ ] Player controls:
  - Play/pause
  - Seek
  - Volume control
  - Loop settings
  - Get duration
  - Get position
### 5. Rendering Integration
- [ ] Set up mpv render context for wgpu:
  - Use `mpv_opengl` render API
  - Create FBO for mpv to render into
  - Copy FBO to wgpu texture
  - Display in window
- [ ] Handle render updates:
  - Subscribe to mpv render events
  - Redraw window when frame available
  - Maintain sync with video timing
### 6. Window Integration
- [ ] Create video window:
  - Size to video dimensions
  - Apply window options
  - Embed video player
  - Handle resize events
- [ ] Video-specific window features:
  - Control bar (optional)
  - Fullscreen toggle
  - Aspect ratio preservation
### 7. Op Implementation
- [ ] `op_show_video`:
  ```rust
  async fn op_show_video(
      state: Rc<RefCell<OpState>>,
      query: String,
      options: Option<VideoOptions>,
  ) -> Result<WindowHandle>
  ```
- [ ] Query asset by tag or path
- [ ] Create video player
- [ ] Start playback
- [ ] Return window handle
- [ ] Auto-close after video ends or duration
### 8. Audio Synchronization
- [ ] Ensure audio plays in sync
- [ ] Use mpv's built-in audio support
- [ ] Respect system volume
- [ ] Optional mute control
### 9. Performance Optimization
- [ ] Hardware decoding when available
- [ ] Efficient texture updates
- [ ] Limit concurrent video windows (from settings)
- [ ] Resource cleanup on window close
### 10. Error Handling
- [ ] Handle missing video files
- [ ] Handle unsupported formats
- [ ] Handle mpv initialization errors
- [ ] Provide clear error messages
### 11. Platform-Specific Considerations
- [ ] **Linux**:
  - May require system packages (libmpv, mesa)
  - Wayland vs X11 differences
  - GPU driver issues
- [ ] **Windows**:
  - Bundle mpv DLLs or download
  - Set PATH or library directory
- [ ] **macOS**:
  - Code signing considerations
  - Metal vs OpenGL backend
### 12. Video Formats Support
- [ ] MP4 (H.264, H.265)
- [ ] WebM (VP8, VP9)
- [ ] AVI
- [ ] MKV
- [ ] MOV
- [ ] Others supported by mpv
## Example Usage (TypeScript)
```typescript
// Play a random animal video
const handle = await showVideo("tag:animal", {
    duration: 30,        // Auto-close after 30 seconds
    loop: true,          // Loop video
    volume: 0.8,         // 80% volume
    alwaysOnTop: true,
    noDecorations: true
});
// Play specific video
await showVideo("path:video/test-bunny.mp4", {
    position: { x: 100, y: 100 }
});
```
## Acceptance Criteria
- [ ] Videos play smoothly with audio
- [ ] libmpv auto-downloads on first use
- [ ] Window options are respected
- [ ] Asset queries work correctly
- [ ] Multiple videos can play simultaneously
- [ ] Auto-close works after duration or video end
- [ ] Hardware decoding utilized when available
- [ ] Performance is acceptable (playback at native FPS)
- [ ] Resources cleaned up on window close
- [ ] Works on all target platforms
## Dependencies
- Requires: #[GUI Window Manager]
- Requires: #[Pack Asset Loading]
- Requires: #[deno_core Runtime Setup]
## Related Issues
- #2 Architecture Documentation
- #[Image Rendering]
- #[Audio Playback]