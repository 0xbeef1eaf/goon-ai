## Objective
Implement image rendering for static images and animated GIFs (hypno) using wgpu.
## Tasks
### 1. Image Module Structure
- [ ] Create image rendering module:
  ```
  src/
  └── media/
      └── image/
          ├── mod.rs
          ├── loader.rs         // Image loading
          ├── renderer.rs       // wgpu image rendering
          └── animation.rs      // GIF animation support
  ```
### 2. Image Loading
- [ ] Implement image loader:
  - Load from file path
  - Support formats: PNG, JPEG, GIF, WebP
  - Handle errors gracefully
  - Decode to RGBA8
- [ ] Use `image` crate:
  ```rust
  let img = image::open(path)?;
  let rgba = img.to_rgba8();
  ```
### 3. Image Rendering Pipeline
- [ ] Create wgpu texture from image:
  - Upload to GPU
  - Create sampler
  - Set up bind group
- [ ] Implement shader pipeline:
  - Vertex shader: full-screen quad
  - Fragment shader: texture sampling
  - Support for opacity
- [ ] Handle aspect ratio:
  - Fit to window
  - Maintain proportions
  - Optional scaling modes (fit, fill, stretch)
### 4. GIF Animation Support
- [ ] Parse GIF frames:
  - Extract all frames
  - Get frame delays
  - Handle loop count
- [ ] Implement animation player:
  - Play frames in sequence
  - Respect frame timing
  - Loop continuously
  - Update texture on each frame
- [ ] Consider using `image` crate's GIF decoder or `gif` crate
### 5. Rendering Integration
- [ ] Implement `ImageRenderer`:
  ```rust
  pub struct ImageRenderer {
      texture: wgpu::Texture,
      bind_group: wgpu::BindGroup,
      pipeline: wgpu::RenderPipeline,
      opacity: f32,
  }
  ```
- [ ] Render method:
  - Clear background (transparent)
  - Render textured quad
  - Apply opacity
  - Present to surface
### 6. Window Integration
- [ ] Create window with image content
- [ ] Size window to image dimensions (or specified size)
- [ ] Handle window resize events
- [ ] Auto-close after duration
### 7. Op Implementation
- [ ] `op_show_image`:
  ```rust
  async fn op_show_image(
      state: Rc<RefCell<OpState>>,
      query: String,
      options: Option<ImageOptions>,
  ) -> Result<WindowHandle>
  ```
- [ ] Query asset by tag or path
- [ ] Create window with image renderer
- [ ] Return window handle
- [ ] Respect permissions
### 8. Hypno-Specific Features
- [ ] `op_show_hypno` (alias for animated GIFs)
- [ ] Full-screen option for immersive experience
- [ ] Smooth transitions between frames
- [ ] Consider special effects (blur, pulse)
### 9. Performance Optimization
- [ ] Texture caching (don't reload same image)
- [ ] Lazy loading for large images
- [ ] Asynchronous loading (don't block runtime)
- [ ] Limit concurrent image windows (from settings)
### 10. Dependencies to Add
```toml
[dependencies]
# (already added)
image = { version = "0.25", features = ["gif"] }
```
### 11. Shader Code
- [ ] Write WGSL shaders:
  ```wgsl
  // vertex.wgsl
  @vertex
  fn vs_main(@builtin(vertex_index) vertex_index: u32) -> @builtin(position) vec4<f32> {
      // Full-screen quad
  }
  
  // fragment.wgsl
  @fragment
  fn fs_main(@location(0) tex_coords: vec2<f32>) -> @location(0) vec4<f32> {
      let color = textureSample(t_texture, s_texture, tex_coords);
      return vec4<f32>(color.rgb, color.a * opacity);
  }
  ```
## Example Usage (TypeScript)
```typescript
// Show a random beach image
const handle = await showImage("tag:beach", {
    duration: 10,
    opacity: 0.95,
    position: { x: 100, y: 100 },
    alwaysOnTop: true,
    clickThrough: true
});
// Show hypno spiral animation
const spiral = await showHypno("tag:spiral", {
    duration: 60,
    alwaysOnTop: true,
    noDecorations: true
});
```
## Acceptance Criteria
- [ ] Static images render correctly
- [ ] GIF animations play smoothly
- [ ] Opacity control works
- [ ] Window options are respected
- [ ] Asset queries work (tag and path)
- [ ] Performance is good (60 FPS for GIFs)
- [ ] Multiple images can display simultaneously
- [ ] Memory usage is reasonable
- [ ] Auto-close works after duration
## Dependencies
- Requires: #[GUI Window Manager]
- Requires: #[Pack Asset Loading]
- Requires: #[deno_core Runtime Setup]
## Related Issues
- #2 Architecture Documentation
- #[Video Rendering]