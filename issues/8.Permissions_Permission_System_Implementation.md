## Objective
Implement the permission system that controls which SDK functions are available based on pack requests and user grants.
## Tasks
### 1. Permissions Module Structure
- [ ] Create permissions module:
  ```
  src/
  └── permissions/
      ├── mod.rs
      ├── types.rs          // Permission types and definitions
      ├── resolver.rs       // Permission resolution logic
      └── checker.rs        // Runtime permission checking
  ```
### 2. Permission Types
- [ ] Define permission categories:
  ```rust
  enum Permission {
      Image,
      Video,
      Audio,
      Hypno,
      Wallpaper,
      Prompt,
      Website,
      // Future: network, filesystem, etc.
  }
  ```
- [ ] Implement string parsing for YAML configs
- [ ] Add validation for unknown permissions
### 3. Permission Sets
- [ ] Define `PermissionSet` struct:
  ```rust
  struct PermissionSet {
      permissions: HashSet<Permission>,
  }
  ```
- [ ] Implement set operations:
  - Union (pack + user)
  - Intersection
  - Difference
  - Contains check
### 4. Permission Resolution
- [ ] Implement `PermissionResolver`:
  - Load pack requested permissions
  - Load user granted permissions
  - Compute union of both sets
  - Return active `PermissionSet`
- [ ] Handle edge cases:
  - Pack requests permission user hasn't granted
  - User has permission pack doesn't request
  - Empty permission sets
### 5. Runtime Checking
- [ ] Implement `PermissionChecker`:
  - Store active `PermissionSet`
  - Provide `has_permission()` method
  - Fast lookup (HashSet)
  - Thread-safe (Arc<PermissionSet>)
- [ ] Integrate with deno_core OpState:
  ```rust
  runtime_state.put(permissions.clone());
  ```
### 6. Permission-Based SDK Filtering
- [ ] Map ops to required permissions:
  ```rust
  const OP_PERMISSIONS: &[(&str, Permission)] = &[
      ("op_show_image", Permission::Image),
      ("op_show_video", Permission::Video),
      ("op_play_audio", Permission::Audio),
      // ...
  ];
  ```
- [ ] Filter SDK generation by active permissions
- [ ] Register ops conditionally in deno_core
### 7. Configuration Schema
- [ ] Document permission format in configs:
  ```yaml
  # In pack config.yaml
  permissions:
    - image
    - video
    - audio
  
  # In settings.yaml
  runtime:
    permissions:
      - image
      - video
      - audio
      - prompt
  ```
### 8. Error Messages
- [ ] Clear error when permission denied:
  ```
  Permission denied: 'video'
  
  This action requires the 'video' permission.
  The pack has requested this permission, but it has not been granted.
  
  To grant this permission, add 'video' to runtime.permissions in settings.yaml
  ```
### 9. Permission UI (Future)
- [ ] Design permission grant flow for GUI
- [ ] Document permission meanings for users
- [ ] Consider granular permissions (e.g., video.fullscreen)
### 10. Testing
- [ ] Unit tests for permission resolution:
  - Union logic
  - Edge cases (empty sets, disjoint sets)
  - String parsing
- [ ] Integration tests:
  - Op execution with/without permission
  - SDK generation filtering
  - Error messages
## Permission Categories
### Core Permissions
- **image**: Display static images
- **video**: Play video files
- **audio**: Play audio files
- **hypno**: Display hypno animations (GIFs)
- **wallpaper**: Set desktop wallpaper
- **prompt**: Show text prompts/messages
- **website**: Open URLs in browser
### Future Permissions (Not Implemented Yet)
- **network**: Make HTTP requests
- **filesystem**: Read/write files
- **system**: System information access
- **notifications**: Show system notifications
- **clipboard**: Access clipboard
## Acceptance Criteria
- [ ] Permission union is correctly computed
- [ ] Only permitted ops are available
- [ ] Permission checks are enforced at runtime
- [ ] Clear errors when permission denied
- [ ] SDK generation respects permissions
- [ ] Configuration properly parsed from YAML
- [ ] Thread-safe permission checking
- [ ] Performance is acceptable (permission checks are fast)
## Dependencies
- Requires: #[Core Initialization]
## Related Issues
- #2 Architecture Documentation
- #[Rust Bindings & SDK Generation]
- #[deno_core Runtime Setup]