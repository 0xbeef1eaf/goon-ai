## Objective
Implement audio playback for MP3 and other audio formats without creating visible windows.
## Tasks
### 1. Audio Module Structure
- [ ] Create audio module:
  ```
  src/
  └── media/
      └── audio/
          ├── mod.rs
          ├── player.rs         // Audio player
          └── manager.rs        // Track playing audio
  ```
### 2. Audio Library Selection
- [ ] Choose audio library (options):
  - **rodio**: Pure Rust, simple API, good format support
  - **cpal**: Low-level, more control
  - **libmpv2**: Reuse video library (if already integrated)
- [ ] Recommended: **rodio** for simplicity
### 3. Audio Player Implementation
- [ ] Implement `AudioPlayer`:
  ```rust
  pub struct AudioPlayer {
      stream_handle: OutputStreamHandle,
      sink: Sink,
      file_path: PathBuf,
      duration: Duration,
  }
  ```
- [ ] Player controls:
  - Play
  - Pause/resume
  - Stop
  - Volume control
  - Get duration
  - Get position
  - Is finished?
### 4. Audio Manager
- [ ] Track all playing audio:
  - Active audio handles
  - Enforce max concurrent audio (from settings)
  - Auto-stop oldest when limit reached
- [ ] Audio handle system:
  ```rust
  pub struct AudioHandle(Uuid);
  ```
### 5. Format Support
- [ ] Support common formats:
  - MP3
  - WAV
  - OGG/Vorbis
  - FLAC
  - AAC (if supported by library)
- [ ] Decode using `symphonia` or rodio's built-in decoders
### 6. Op Implementation
- [ ] `op_play_audio`:
  ```rust
  async fn op_play_audio(
      state: Rc<RefCell<OpState>>,
      query: String,
      options: Option<AudioOptions>,
  ) -> Result<AudioHandle>
  ```
- [ ] Query asset by tag or path
- [ ] Create audio player
- [ ] Start playback
- [ ] Return audio handle
- [ ] Auto-stop after duration or file end
### 7. Playback Control Ops
- [ ] `op_stop_audio(handle: AudioHandle)` - Stop specific audio
- [ ] `op_pause_audio(handle: AudioHandle)` - Pause audio
- [ ] `op_resume_audio(handle: AudioHandle)` - Resume audio
- [ ] `op_set_audio_volume(handle: AudioHandle, volume: f32)` - Set volume
### 8. Background Playback
- [ ] Audio plays without window
- [ ] Continue playing in background
- [ ] Clean up when finished
- [ ] Cancel on app shutdown
### 9. Settings Integration
- [ ] Respect `settings.runtime.popups.audio.max` limit
- [ ] Apply timeout from settings if not specified
- [ ] Consider system volume settings
### 10. Dependencies to Add
```toml
[dependencies]
# (existing dependencies)
rodio = "0.19"
# OR for more control:
# cpal = "0.15"
# symphonia = { version = "0.5", features = ["mp3", "aac", "flac", "vorbis"] }
```
### 11. Error Handling
- [ ] Handle missing audio files
- [ ] Handle unsupported formats
- [ ] Handle audio device errors
- [ ] Provide clear error messages
### 12. Performance Considerations
- [ ] Asynchronous loading and playback
- [ ] Low CPU usage during playback
- [ ] Efficient format decoding
- [ ] Memory usage for buffering
## Example Usage (TypeScript)
```typescript
// Play a test audio file
const handle = await playAudio("tag:test", {
    volume: 0.8,
    loop: false
});
// Stop audio
await stopAudio(handle);
// Play with auto-stop after 5 seconds
await playAudio("path:audio/sample-12s.mp3", {
    duration: 5,
    volume: 0.5
});
```
## Acceptance Criteria
- [ ] Audio plays correctly
- [ ] Multiple audio files can play simultaneously
- [ ] Volume control works
- [ ] Auto-stop works after duration or file end
- [ ] Asset queries work correctly
- [ ] Respects max audio limit from settings
- [ ] No audio glitches or stuttering
- [ ] Clean resource cleanup
- [ ] Works on all target platforms
- [ ] Low CPU usage during playback
## Dependencies
- Requires: #[Pack Asset Loading]
- Requires: #[deno_core Runtime Setup]
- Requires: #[Permissions System]
## Related Issues
- #2 Architecture Documentation
- #[Video Rendering] (shares some concepts)
