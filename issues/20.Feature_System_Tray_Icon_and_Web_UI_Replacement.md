# Feature: System Tray Icon with Control Menu

## Overview
Implement a system tray icon that provides quick access to core application controls. This will replace the web UI functionality and allow goon.ai to operate as a true background application with a minimal GUI surface.

## Goals
1. Add system tray icon to desktop environment
2. Provide quick access to Run/Pause, Config, Pack Editor, and Exit
3. Remove dependency on web UI
4. Consolidate all GUI functionality into native Slint windows

## Architecture

### Components to Implement

#### 1. Tray Icon Manager
**File**: `src/gui/tray_manager.rs` (new)

```rust
pub struct TrayManager {
    // Manage tray icon lifecycle
}

impl TrayManager {
    pub fn new() -> Result<Self>;
    pub fn show_icon() -> Result<()>;
    pub fn hide_icon() -> Result<()>;
    pub fn set_menu(&self, menu: TrayMenu) -> Result<()>;
}
```

**Responsibilities**:
- Create and manage tray icon
- Handle menu interactions
- Respond to system tray events (click, right-click)

#### 2. Tray Menu Handler
**File**: `src/gui/tray_menu.rs` (new)

Menu items and their actions:
- **Run/Pause**: Toggle orchestrator state (start/stop main loop)
- **Configuration**: Open config window
- **Pack Editor**: Open pack editor window
- **Exit**: Quit application

```rust
pub enum MenuAction {
    ToggleRun,
    OpenConfig,
    OpenPackEditor,
    Exit,
}

impl MenuAction {
    pub async fn execute(&self, app_state: &AppState) -> Result<()>;
}
```

#### 3. Configuration Window (Slint)
**File**: `src/gui/config/config.slint` (new)

Replace web UI's configuration page with native Slint window:
- Display current settings from `settings.yaml`
- Allow modification of:
  - LLM model selection
  - Mood settings
  - Audio/Video concurrency limits
  - Pack selection
  - Mood filtering
- Save changes back to settings file
- Real-time validation

**Key Properties**:
```slint
export component ConfigWindow inherits Window {
    in property <string> current-model;
    in property <string> current-mood;
    in property <int> max-audio;
    in property <int> max-video;

    callback save-config(model: string, mood: string);
    callback cancel();
}
```

#### 4. Pack Editor Window (Slint)
**File**: `src/gui/pack-editor/pack-editor.slint` (new)

Replace web UI's pack editor with native Slint window:
- List available packs
- Create/edit/delete packs
- Manage pack contents (images, videos, audio, etc.)
- Configure pack properties (name, version, description)
- Edit mood filters and tags

**Key Components**:
```slint
export component PackEditor inherits Window {
    in property <[Pack]> available-packs;

    callback create-pack();
    callback edit-pack(pack-id: string);
    callback delete-pack(pack-id: string);
    callback save-changes();
}
```

#### 5. Orchestrator Control Interface
**File**: `src/app_loop/control.rs` (new)

Add methods to control orchestrator state:
```rust
pub struct OrchestrationControl {
    // Control running/paused state
}

impl OrchestrationControl {
    pub async fn pause() -> Result<()>;
    pub async fn resume() -> Result<()>;
    pub async fn is_running() -> Result<bool>;
}
```

## Data Flow

```
User clicks Tray Icon
    ↓
TrayManager receives click event
    ↓
Present context menu
    ↓
User selects action (Run/Pause, Config, etc.)
    ↓
MenuAction::execute()
    ↓
Appropriate action taken:
    - ToggleRun → OrchestrationControl::pause()/resume()
    - OpenConfig → Create ConfigWindow and populate with current settings
    - OpenPackEditor → Create PackEditor window
    - Exit → Graceful shutdown
```

## Implementation Plan

### Phase 1: Tray Icon & Menu (Foundation)
1. **Add tray icon dependency**:
   - Evaluate crates: `tray-icon`, `libappindicator`, or similar
   - Consider Linux (AppIndicator), macOS (NSStatusBar), Windows (NotifyIcon)

2. **Create TrayManager**:
   - Initialize tray icon on startup
   - Handle menu click events
   - Route to MenuAction handlers

3. **Implement MenuAction::execute()**:
   - Route actions to appropriate handlers
   - Start with Run/Pause and Exit (simplest)

4. **Integrate with App::run()**:
   - Create TrayManager after event loop starts
   - Ensure tray icon shows immediately

### Phase 2: Configuration Window
1. **Create config.slint**:
   - Design form layout with input fields
   - Bind to app state properties
   - Add save/cancel buttons

2. **Build ConfigWindow data model**:
   - Parse current `settings.yaml`
   - Provide read/write interface for settings
   - Validate user input before saving

3. **Handle save events**:
   - Write changes to `settings.yaml`
   - Reload app configuration
   - Show success/error notification

### Phase 3: Pack Editor Window
1. **Create pack-editor.slint**:
   - List view of available packs
   - Forms for pack properties
   - Asset browser for pack contents

2. **Build pack management backend**:
   - Implement create/edit/delete operations
   - File I/O for pack config.yaml
   - Asset file management

3. **Connect editor to file system**:
   - Watch pack directories for changes
   - Reload pack data when modified
   - Handle file errors gracefully

### Phase 4: Web UI Removal
1. Disable web server in `src/server/`
2. Remove web UI build from CI/CD
3. Update documentation
4. Cleanup unused web dependencies from Cargo.toml

## Technical Considerations

### Linux Tray Icon Support
- **AppIndicator Protocol**: Standard on GNOME/KDE, requires `libappindicator`
- **System Tray XEmbed**: Fallback for minimal window managers
- **Wayland Support**: AppIndicator is more reliable on Wayland than XEmbed

### Cross-Platform Compatibility
- Linux: AppIndicator (KDE/GNOME) + XEmbed (others)
- macOS: NSStatusBar via cocoa crate
- Windows: Win32 NotifyIcon API

### State Management
- Tray menu must reflect current orchestrator state (Running/Paused)
- Config window must load current settings on open
- Pack editor must handle concurrent modifications
- Use channels to communicate between tray menu and orchestrator

### Error Handling
- Graceful degradation if tray icon unavailable
- Show notifications for config save errors
- Validate pack edits before writing to disk
- Log all tray interactions

## Dependencies to Add

```toml
# Tray icon support
tray-icon = "0.14"  # Cross-platform tray icon library

# Configuration management (if needed)
serde_yaml = "0.9"  # For reading/writing settings.yaml

# File watcher (for pack editor)
notify = "6.0"      # For monitoring pack directory changes
```

## Testing Strategy

### Unit Tests
- MenuAction execution logic
- Settings validation
- Pack CRUD operations

### Integration Tests
- Tray menu click handling
- Config window save/load cycle
- Pack editor create/edit/delete flow
- Orchestrator pause/resume

### Manual Testing
- Tray icon visibility on different DMs (GNOME, KDE, etc.)
- Menu responsiveness
- Config changes persistence
- Pack editor file operations

## Success Criteria

✓ Tray icon visible on system tray
✓ All menu items functional and responsive
✓ Configuration window displays current settings
✓ Pack editor allows CRUD operations
✓ Changes persist across app restarts
✓ Web UI completely removed
✓ No external dependencies on web server
✓ All tests passing

## Migration Path from Web UI

1. **Parallel Operation** (during development):
   - Keep web UI running
   - Implement native windows alongside
   - Allow testing both interfaces

2. **Gradual Transition**:
   - Mark web UI as deprecated
   - Document native window usage
   - Get user feedback on new interface

3. **Cutover**:
   - Remove web UI server
   - Update startup docs
   - Clean up dependencies

## Related Issues
- Issue #9: GUI Window Manager with winit and wgpu
- Issue #19: GUI Slint Migration and Keyboard Focus Problem
- Web UI removal tracking (new)

## Open Questions

1. **Keyboard Focus on Wayland**: Will tray-triggered windows have the same focus issue as prompt windows? May need to implement workarounds consistently.

2. **Pack Editor Complexity**: How complex should the visual pack editor be? Consider MVP vs. full-featured approach.

3. **Settings Persistence**: Should config changes trigger immediate app reload or require restart?

4. **Multi-Monitor Support**: How should tray windows position on multi-monitor setups?

## Notes

- This feature directly depends on resolving the keyboard focus issue (Issue #19)
- Config window complexity should be kept similar to web UI for user familiarity
- Pack editor can start simple and be enhanced later
- Tray icon is the visual anchor for the app - should be reliable and always visible
