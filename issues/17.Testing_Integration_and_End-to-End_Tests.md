## Objective
Create comprehensive testing infrastructure for the project including unit tests, integration tests, and end-to-end tests.
## Tasks
### 1. Test Infrastructure
- [ ] Set up test directory structure:
  ```
  tests/
  ├── integration/
  │   ├── mod.rs
  │   ├── config_test.rs
  │   ├── permissions_test.rs
  │   └── loop_test.rs
  ├── e2e/
  │   ├── mod.rs
  │   └── full_flow_test.rs
  └── fixtures/
      ├── test_pack/
      └── test_settings.yaml
  ```
### 2. Unit Tests
- [ ] Test configuration loading
- [ ] Test permission resolution
- [ ] Test asset registry
- [ ] Test TypeScript compilation
- [ ] Test SDK generation
- [ ] Test each module independently
### 3. Mock Infrastructure
- [ ] Mock LLM responses:
  ```rust
  struct MockLLM {
      responses: VecDeque<String>,
  }
  ```
- [ ] Mock asset loading
- [ ] Mock window creation (headless tests)
- [ ] Mock media playback
### 4. Integration Tests
- [ ] Test pack loading → asset registry
- [ ] Test permission system → SDK generation
- [ ] Test LLM → compilation → execution flow
- [ ] Test window creation → rendering (if possible)
- [ ] Test error handling and retry logic
### 5. End-to-End Tests
- [ ] Test full application flow:
  1. Initialize with test pack
  2. Mock LLM response with TypeScript
  3. Compile and execute
  4. Verify correct ops called
  5. Verify results returned
- [ ] Test error scenarios
- [ ] Test retry logic
- [ ] Test graceful shutdown
### 6. Test Fixtures
- [ ] Create minimal test pack:
  - Simple config.yaml
  - Few test assets (small files)
  - Basic permissions
  - Simple LLM config
- [ ] Create test settings file
- [ ] Create test TypeScript snippets
### 7. CI/CD Integration
- [ ] Set up GitHub Actions:
  ```yaml
  name: Tests
  on: [push, pull_request]
  jobs:
    test:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v2
        - uses: actions-rs/toolchain@v1
        - run: cargo test
        - run: cargo test --release
  ```
- [ ] Run tests on multiple platforms (Linux, Windows, macOS)
- [ ] Check code coverage
### 8. Performance Tests
- [ ] Benchmark compilation time
- [ ] Benchmark execution time
- [ ] Benchmark rendering performance
- [ ] Memory usage tests
- [ ] Concurrent window tests
### 9. Property-Based Tests
- [ ] Use `proptest` for randomized testing:
  - Random TypeScript generation
  - Random permission combinations
  - Random asset queries
- [ ] Test invariants and edge cases
### 10. Documentation Tests
- [ ] Ensure doc examples compile:
  ```rust
  /// ```
  /// let result = do_something();
  /// assert_eq!(result, expected);
  /// ```
  ```
- [ ] Test README examples
- [ ] Keep docs in sync with code
### 11. Error Path Testing
- [ ] Test all error conditions:
  - Missing config files
  - Invalid YAML
  - Missing assets
  - Permission denied
  - Compilation errors
  - Runtime errors
  - LLM offline
  - Out of memory
- [ ] Verify error messages are helpful
### 12. Dependencies to Add
```toml
[dev-dependencies]
tokio-test = "0.4"
mockall = "0.13"
proptest = "1.4"
serial_test = "3.0"  # For tests that can't run in parallel
tempfile = "3.8"     # For temporary test files
```
## Test Categories
### Fast Tests (< 1s)
- Unit tests
- Configuration parsing
- Permission resolution
- SDK generation
### Medium Tests (1-10s)
- Integration tests
- Compilation tests
- Mock execution tests
### Slow Tests (> 10s)
- E2E tests with actual LLM
- Rendering tests
- Long-running loops
- Platform-specific tests
## Continuous Integration
### Pre-Commit Hooks
- [ ] Run fast tests
- [ ] Run clippy
- [ ] Run rustfmt
- [ ] Check for compilation warnings
### Pull Request Checks
- [ ] All tests pass
- [ ] Code coverage > 70%
- [ ] No clippy warnings
- [ ] Documentation builds
### Release Checks
- [ ] All tests pass on all platforms
- [ ] Performance benchmarks acceptable
- [ ] No memory leaks
- [ ] Clean shutdown
## Acceptance Criteria
- [ ] Comprehensive unit test coverage (> 70%)
- [ ] Integration tests for all major flows
- [ ] E2E test demonstrates full functionality
- [ ] CI/CD pipeline set up and passing
- [ ] Tests run on Linux, Windows, macOS
- [ ] Mock infrastructure in place
- [ ] Error paths tested
- [ ] Documentation examples tested
- [ ] Performance benchmarks established
## Dependencies
- Requires: All implementation issues
## Related Issues
- #1 Architecture Documentation