## Objective
Implement desktop wallpaper setting functionality across different platforms.
## Tasks
### 1. Wallpaper Module Structure
- [ ] Create wallpaper module:
  ```
  src/
  └── media/
      └── wallpaper/
          ├── mod.rs
          ├── linux.rs          // Linux implementation
          ├── windows.rs        // Windows implementation
          └── macos.rs          // macOS implementation
  ```
### 2. Platform Abstraction
- [ ] Define common interface:
  ```rust
  pub trait WallpaperSetter {
      fn set_wallpaper(&self, path: &Path) -> Result<()>;
      fn get_wallpaper(&self) -> Result<PathBuf>;
  }
  ```
- [ ] Platform-specific implementations
- [ ] Compile-time platform selection
### 3. Linux Implementation
- [ ] Detect desktop environment:
  - GNOME/Ubuntu
  - KDE Plasma
  - XFCE
  - Cinnamon
  - MATE
  - Others
- [ ] Set wallpaper via:
  - **GNOME**: `gsettings set org.gnome.desktop.background picture-uri`
  - **KDE**: `qdbus org.kde.plasmashell /PlasmaShell`
  - **XFCE**: `xfconf-query -c xfce4-desktop`
  - **Generic X11**: `feh --bg-scale` or `nitrogen`
- [ ] Copy image to persistent location (e.g., `~/.local/share/goon-ai/wallpapers/`)
### 4. Windows Implementation
- [ ] Use Windows API:
  - `SystemParametersInfoW` with `SPI_SETDESKWALLPAPER`
  - Update registry for persistence
- [ ] Support both:
  - Current user wallpaper
  - Lock screen (optional)
- [ ] Handle Windows 10/11 differences
### 5. macOS Implementation
- [ ] Use AppleScript or native APIs:
  ```applescript
  tell application "Finder"
      set desktop picture to POSIX file "/path/to/image.jpg"
  end tell
  ```
- [ ] Or use `osascript` from Rust
- [ ] Support multiple displays (set same on all)
### 6. Op Implementation
- [ ] `op_set_wallpaper`:
  ```rust
  async fn op_set_wallpaper(
      state: Rc<RefCell<OpState>>,
      query: String,
      options: Option<WallpaperOptions>,
  ) -> Result<()>
  ```
- [ ] Query asset by tag or path
- [ ] Copy image to temp/persistent location
- [ ] Call platform-specific setter
- [ ] Return success/error
### 7. Image Preparation
- [ ] Validate image format
- [ ] Optionally resize to screen resolution
- [ ] Convert format if needed (platform requirements)
- [ ] Ensure file persists after setting
### 8. Error Handling
- [ ] Handle permission errors
- [ ] Handle unsupported desktop environments
- [ ] Provide fallback mechanisms
- [ ] Clear error messages
### 9. Settings Integration
- [ ] Respect wallpaper permission
- [ ] Consider "restore on exit" option (future)
- [ ] Track previous wallpaper (for restoration)
### 10. Dependencies to Add
```toml
[dependencies]
# Platform-specific
[target.'cfg(windows)'.dependencies]
windows = { version = "0.58", features = ["Win32_UI_WindowsAndMessaging"] }
[target.'cfg(target_os = "linux")'.dependencies]
# May not need extra deps (use std::process::Command)
[target.'cfg(target_os = "macos")'.dependencies]
# May not need extra deps (use std::process::Command for osascript)
```
### 11. Testing Strategy
- [ ] Test on different desktop environments
- [ ] Verify persistence across reboots
- [ ] Test with various image formats
- [ ] Handle edge cases (no permission, unsupported DE)
### 12. Documentation
- [ ] Document supported platforms/DEs
- [ ] Document required permissions
- [ ] Note limitations (e.g., Wayland restrictions)
## Example Usage (TypeScript)
```typescript
// Set wallpaper to random nature image
await setWallpaper("tag:nature,landscape");
// Set specific wallpaper
await setWallpaper("path:wallpaper/test.jpg");
// Query multiple tags
await setWallpaper("tag:mountain,sunny");
```
## Platform Support
### Linux
- GNOME/Ubuntu: Full support
- KDE Plasma: Full support
- XFCE: Full support
- Others: Best effort (may require feh/nitrogen)
- Wayland: Limited (DE-dependent)
### Windows
- Windows 10: Full support
- Windows 11: Full support
### macOS
- macOS 10.14+: Full support
- Multiple displays: Sets same on all
## Acceptance Criteria
- [ ] Can set wallpaper on all target platforms
- [ ] Asset queries work correctly
- [ ] Wallpaper persists after setting
- [ ] Handles unsupported platforms gracefully
- [ ] Permission checks enforced
- [ ] Clear error messages
- [ ] Works across different desktop environments (Linux)
- [ ] Image formats are handled correctly
## Dependencies
- Requires: #3 Pack Asset Loading
- Requires: #6 deno_core Runtime Setup
- Requires: #8 Permissions System
## Related Issues
- #1 Architecture Documentation
- #10 Image Rendering