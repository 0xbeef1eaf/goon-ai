# Issue 19: GUI Slint Migration and Keyboard Focus Problem

## Summary
Successfully migrated the GUI from wgpu to Slint 1.8 with proper threading using `slint::spawn_local()`. The window now displays correctly, but keyboard focus cannot be obtained - users cannot type in the prompt window even when clicking on it.

## Background
- **Previous GUI System**: wgpu-based custom window rendering
- **New GUI System**: Slint 1.8 with winit backend
- **Threading Model**: Slint is single-threaded; uses `thread_local!` for window storage

## What Works ✓
1. Window creation and display
2. Text rendering with custom font sizes and colors
3. Window sizing and positioning
4. Application loop integration via `slint::spawn_local()`
5. All 64 unit tests pass
6. Code compiles with no errors (only a future compatibility warning from ashpd)

## The Problem ✗
**Keyboard focus is not working.** The prompt window:
- Shows correctly on screen
- Cannot receive keyboard input
- Does not get focus when clicked
- Does not respond to `focus()` calls from Slint code

### Environment Details
- **OS**: Linux with KDE Plasma
- **Display Server**: Wayland (not X11)
- **Slint Backend**: winit with Wayland support enabled
- **Issue Severity**: Critical - blocks user input functionality

## Attempted Solutions

### 1. FocusScope with Init Callback
```slint
FocusScope {
    init => { input-handler.focus(); }
}
```
**Result**: No focus ❌

### 2. Forward-Focus Property
```slint
forward-focus: input-field;
```
**Result**: No focus ❌

### 3. TouchArea Click Handler
```slint
TouchArea {
    clicked => { input-field.focus(); }
}
```
**Result**: No focus when clicked ❌

### 4. TextInput Element (Native Slint)
Switched from FocusScope to TextInput component.
**Result**: No focus ❌

### 5. LineEdit from std-widgets
```slint
import { LineEdit } from "std-widgets.slint";

user-text-input := LineEdit {
    text <=> root.user-input;
    placeholder-text: "Type here...";
}

public function grab-focus() {
    user-text-input.focus();
}
```
**Result**: No focus ❌

### 6. Window Decorations Disabled (no-frame: false)
```slint
export component PromptWindow inherits Window {
    no-frame: false;  // Enable window decorations
    forward-focus: user-text-input;
}
```
**Result**: Window has no title bar, still no focus ❌

### 7. Timer-Based Delayed Focus
```slint
init => {
    focus-timer.restart();
}

focus-timer := Timer {
    interval: 100ms;
    triggered => {
        user-text-input.focus();
    }
}
```
**Result**: No focus ❌

## Root Cause Analysis

The issue is likely one or more of:

1. **Wayland Focus Stealing Prevention**: Wayland has stricter focus policies than X11. Windows cannot steal focus without user interaction, and undecorated windows may have restrictions.

2. **Undecorated Windows (decorations: false)**: The prompt windows are created with `decorations: false` by default. Wayland may not properly handle focus for undecorated windows.

3. **Slint/Winit Integration**: The Slint winit backend may not be properly requesting focus from the OS. The raw winit window underneath might need explicit focus requests via its platform-specific APIs.

4. **Event Loop Timing**: The focus call happens before the window is fully initialized in the compositor.

## Technical Details

### Current Implementation

**src/gui/slint_controller.rs**:
```rust
thread_local! {
    static WINDOW_STATE: RefCell<HashMap<WindowHandle, Rc<PromptWindow>>>
        = RefCell::new(HashMap::new());
}

impl GuiInterface for SlintGuiController {
    fn create_window(&self, options: WindowOptions) -> Result<WindowHandle> {
        let window = PromptWindow::new()?;
        window.show()?;
        window.window().request_redraw();
        WINDOW_STATE.with(|state| {
            state.borrow_mut().insert(handle, Rc::new(window));
        });
        Ok(handle)
    }
}
```

**src/media/prompt/prompt.slint**:
```slint
export component PromptWindow inherits Window {
    in property <string> prompt-text;
    in-out property <string> user-input;

    user-text-input := LineEdit {
        text <=> root.user-input;
        placeholder-text: "Type here...";
        accepted(text) => {
            root.input-submitted(text);
        }
    }

    public function grab-focus() {
        user-text-input.focus();
    }
}
```

### Dependencies
- Slint 1.8 with features:
  - `backend-winit`
  - `backend-winit-x11`
  - `backend-winit-wayland`
- winit 0.30+

### Cargo.toml Slint Section
```toml
slint = { version = "1.8", features = [
    "backend-winit",
    "backend-winit-x11",
    "backend-winit-wayland",
    "std",
    "compat-1-0"
] }
```

## Next Steps / Recommendations

### Short Term
1. **Test on X11**: Verify if focus works on X11 (not Wayland). This would confirm it's a Wayland-specific issue.
2. **Investigate Slint Issues**: Check Slint's GitHub for known Wayland focus issues.
3. **Try Decorations On**: Force all windows to have decorations to see if it helps with focus.

### Medium Term
1. **Access Raw Winit Window**: Use `raw-window-handle` to get the underlying winit window and call platform-specific focus APIs:
   - On Wayland: May need to use wayland-client crate to set focus
   - On X11: Use x11-clipboard or similar for XSetInputFocus

2. **Alternative Input Methods**:
   - Implement paste-from-clipboard functionality as workaround
   - Consider on-screen keyboard with mouse/touch input

3. **Slint Version Upgrade**: Check if newer Slint versions (1.9+) have improvements to focus handling.

### Long Term
1. **Custom Window Manager Integration**: If Slint can't solve it, implement custom winit event handling
2. **Consider Alternative GUI Framework**: If Slint's Wayland support remains problematic, evaluate other options like:
   - egui with native windowing
   - GTK via gtk-rs
   - Qt via cxx

## Files Modified
- `src/gui/slint_controller.rs` - Complete rewrite for single-threaded model
- `src/core/app.rs` - Uses `slint::spawn_local()` pattern
- `src/media/prompt/prompt.slint` - Multiple iterations trying different focus approaches
- `Cargo.toml` - Added Slint dependencies and features

## Related Issues
- Issue #16: Core Main Application Loop Implementation
- Issue #9: GUI Window Manager with winit and wgpu

## Status
- **Branch**: `fix/slint-threading-spawn-local`
- **Build Status**: ✓ Compiling and tests passing
- **Blocker**: Keyboard focus prevents user input

## Notes
- Thread-local storage approach is working correctly for single-threaded Slint model
- Window rendering is correct and responsive
- The focus issue is specific to keyboard input, not window creation/lifecycle
- Issue only manifests on Wayland; may work on X11
