name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache rusty_v8 binaries
        uses: actions/cache@v3
        id: v8-cache
        with:
          path: /tmp/rusty_v8_mirror
          key: rusty_v8-${{ hashFiles('Cargo.lock') }}
      - name: Download rusty_v8 prebuilt binaries
        if: steps.v8-cache.outputs.cache-hit != 'true'
        run: |
          V8_VERSION=$(cargo pkgid --locked v8 | cut -d'@' -f2 | tr -d '\n')
          REPO="https://github.com/denoland/rusty_v8/releases/download/${V8_VERSION}"
          RUSTY_V8_MIRROR=/tmp/rusty_v8_mirror
          mkdir -p $RUSTY_V8_MIRROR

          # Download all assets from the release
          RELEASE_API="https://api.github.com/repos/denoland/rusty_v8/releases/tags/v${V8_VERSION}"
          ASSETS=$(curl -s "$RELEASE_API" | grep -o '"browser_download_url": "[^"]*"' | cut -d'"' -f4)

          for url in $ASSETS; do
            filename=$(basename "$url")
            echo "Downloading $filename..."
            curl -L -o "$RUSTY_V8_MIRROR/$filename" "$url"
          done

          echo "Downloaded files:"
          ls -lh $RUSTY_V8_MIRROR

          echo "Decompressing files..."
          gunzip $RUSTY_V8_MIRROR/*.gz
          echo "Decompression complete."
      - name: Set rusty_v8 mirror environment
        run: echo "RUSTY_V8_MIRROR=/tmp/rusty_v8_mirror" >> $GITHUB_ENV
      - uses: Swatinem/rust-cache@v2
      - name: Build
        run: cargo build --verbose
      - name: Run tests
        run: cargo test --verbose

  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Linting
        run: cargo clippy -- -D warnings
